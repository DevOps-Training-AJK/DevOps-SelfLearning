pipeline {
    agent any
    environment {
        username = "ajithkv98@gmail.com"
        password = credentials('dockerpassword')
    }
    stages {
        stage('checkout-repo') {
            steps {
                script {
                    sh '''
                        if [ -d "Test-Frontend-app-Calculator" ]; then
                            rm -rf 'Test-Frontend-app-Calculator'
                            git clone https://github.com/DevOps-Training-AJK/Test-Frontend-app-Calculator.git
                            cd 'Test-Frontend-app-Calculator'
                            git checkout master
                        else
                            git clone https://github.com/DevOps-Training-AJK/Test-Frontend-app-Calculator.git
                            cd 'Test-Frontend-app-Calculator'
                            git checkout master  
                        fi
                    '''
                }
                
            }
        }
        stage('docker-build') {
            steps {
                script {
                    sh '''
                        ls -al
                        docker login -u ${env.username} -p ${env.password}
                        docker build . -t test:${BUILD_NUMBER}
                        docker push
                    '''
                }
            }
        }
        stage('Deploy') {
            steps {
                script {
                    sh '''
                        kubectl login -u ${KUBE_USER} -p ${KUBE_PASS}
                        kubectl create deployment test-deployment-${BUILD_NUMBER} --image=test:${BUILD_NUMBER}
                        kubectl expose deployment test-deployment-${BUILD_NUMBER} --type=LoadBalancer --port=80 --target-port=80
                    '''
                
            }
        }
    }
}
}
